import{r as m}from"./index.03be2d59.js";import{g as X,L as re,E as P}from"./error.d41e34a3.js";import{M as ie}from"./streamdal.d1597ee0.js";import{F as _,a as Z,e as oe,o as de,s as S,b as ce,d as me,l as q,Z as T,u as ue,S as xe,t as pe,m as fe}from"./success.195e3d70.js";import{j as e}from"./jsx-runtime.b9e88e07.js";import{t as _e}from"./utils.18ab1466.js";function ye({title:s,titleId:a,...t},l){return m.createElement("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor","aria-hidden":"true",ref:l,"aria-labelledby":a},t),s?m.createElement("title",{id:a},s):null,m.createElement("path",{d:"M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"}))}const ge=m.forwardRef(ye),O=ge,U=({name:s,label:a,register:t,error:l,...n})=>e.jsxs("div",{className:"flex flex-col mb-4",children:[e.jsx("label",{className:"text-stormCloud font-medium text-[14px] leading-[18px]",htmlFor:s,children:a}),e.jsx("select",{className:`rounded-sm border outline-0 mt-2 px-2 pe-6 h-[47px] text-[14px] border-${l?"streamdalRed":""}`,...t(s),...n,children:n.children}),e.jsx("div",{className:"text-[12px] mt-1 font-semibold text-streamdalRed",children:l})]}),B=({name:s,value:a,register:t})=>e.jsx("input",{type:"hidden",...t(s),value:a}),H=({index:s,ruleIndex:a,register:t,errors:l})=>e.jsx("div",{className:"w-full",children:e.jsx(_,{name:`rules[${a}][match_config.args[${s}]`,label:"",register:t,error:l["match_config.args"]?.message||"",margin:""})},`rule-arg-key-${s}`),he=({register:s,errors:a,ruleIndex:t})=>{const[l,n]=m.useState([e.jsx(H,{ruleIndex:t,index:0,register:s,errors:a})]);return e.jsxs("div",{className:"flex flex-col mb-2",children:[e.jsx("div",{className:"mb-2 text-stormCloud font-medium text-[14px] leading-[18px]",children:"Field Match Args"}),e.jsxs("div",{className:"flex flex-col mb-2 border rounded-sm px-2",children:[l.map((r,x)=>e.jsxs("div",{className:"flex flex-row justify-between align-middle w-full",children:[r,l.length>1&&e.jsx(O,{className:"ml-2 text-stormCloud w-[20px] cursor-pointer",onClick:()=>n(l.filter((p,i)=>x!==i))})]},`rule-arg-key-${x}`)),e.jsx("div",{className:"w-full my-2 flex justify-end",children:e.jsx("input",{type:"button",className:"flex justify-center btn-secondary h-10 cursor-pointer",value:"+ Add Arg",onClick:()=>n([...l,e.jsx(H,{ruleIndex:t,register:s,errors:a,index:l.length})])})})]})]})},V={RULE_FAILURE_MODE_UNSET:{display:"Unset"},RULE_FAILURE_MODE_REJECT:{display:"Reject"},RULE_FAILURE_MODE_DLQ:{display:"Dead Letter"},RULE_FAILURE_MODE_TRANSFORM:{display:"Transform"},RULE_FAILURE_MODE_ALERT_SLACK:{display:"Slack Alert"}},Y={TRANSFORM_TYPE_REPLACE:{display:"Replace"},TRANSFORM_TYPE_DELETE:{display:"Delete"}},A=({ruleIndex:s,failureMode:a,register:t,control:l,errors:n,index:r})=>{const[x,p]=m.useState(!1),i=Z({control:l,name:`rules[${s}].failure_mode_configs[${r}].mode]`}),g=async()=>{try{const f=await X("/v1/slack");p(!!f?.values?.token)}catch{p(!1)}};m.useEffect(()=>{g()},[]);const b=i||a?.mode||"RULE_FAILURE_MODE_UNSET";return e.jsxs("div",{className:"mt-2 w-full",children:[e.jsx(U,{name:`rules[${s}].failure_mode_configs[${r}].mode]`,label:"Failure Mode Type",register:t,error:n["failure_mode_configs.mode"]?.message||"",children:Object.keys(V).map((f,u)=>e.jsx("option",{value:f,children:V[f].display},`failure-mode-type-option-key-${u}`))}),b==="RULE_FAILURE_MODE_ALERT_SLACK"&&e.jsxs("div",{className:"flex flex-col",children:[e.jsx(_,{name:`rules[${s}].failure_mode_configs[${r}].alert_slack[slack_channel]]`,label:"Slack Channel",register:t,error:n["failure_mode_configs.alert_slack.slack_channel"]?.message||""}),x?null:e.jsxs("div",{className:"mb-4",children:["In order to receive Slack Alerts, you must configure Slack"," ",e.jsx("a",{href:"/slack",className:"underline underline-offset-1",children:"here"}),"."]})]}),b==="RULE_FAILURE_MODE_DLQ"&&e.jsx(_,{name:`rules[${s}].failure_mode_configs[${r}].dlq[streamdal_token]]`,label:"Streamdal Token",register:t,error:n["failure_mode_configs.dlq.streamdal_token"]?.message||""}),b==="RULE_FAILURE_MODE_TRANSFORM"&&e.jsxs(e.Fragment,{children:[e.jsx(_,{name:`rules[${s}].failure_mode_configs[${r}].transform[path]]`,label:"Path",register:t,error:n["failure_mode_configs.transform.path"]?.message||""}),e.jsx(_,{name:`rules[${s}].failure_mode_configs[${r}].transform[value]]`,label:"Value",register:t,error:n["failure_mode_configs.transform.value"]?.message||""}),e.jsx(U,{name:`rules[${s}].failure_mode_configs[${r}].transform[type]]`,label:"Transform Type",register:t,error:n["failure_mode_configs.transform.type"]?.message||"",children:Object.keys(Y).map((f,u)=>e.jsx("option",{value:f,children:Y[f].display},`failure-mode-transform-type-option-key-${u}`))})]})]})},je=({ruleIndex:s,rule:a,register:t,control:l,errors:n})=>{const[r,x]=m.useState(a?.failure_mode_configs?.length?a.failure_mode_configs.map((p,i)=>e.jsx(A,{ruleIndex:s,failureMode:p,index:i,register:t,control:l,errors:n})):[e.jsx(A,{ruleIndex:s,failureMode:{},index:0,register:t,control:l,errors:n})]);return e.jsxs("div",{className:"flex flex-col mb-2",children:[e.jsx("div",{className:"text-stormCloud font-medium text-[14px] leading-[18px]",children:"Failure Modes"}),e.jsxs("div",{className:"flex flex-col my-2 border rounded-sm",children:[r?.length?r?.map((p,i)=>e.jsxs("div",{className:"border-b",children:[e.jsxs("div",{className:"flex flex-row justify-between text-stormCloud font-medium text-[14px] leading-[18px] bg-sunset p-2",children:["Failure Mode ",i+1,".",e.jsx(O,{className:"text-stormCloud w-[20px] cursor-pointer",onClick:()=>x(r.filter((g,b)=>i!==b))})]}),e.jsx("div",{className:"flex flex-row justify-between items-start w-full px-2",children:p})]},`failure-modes-key-${i}`)):e.jsx("div",{className:"p-2 border-b",children:"No failure modes found"}),e.jsx("div",{className:"w-full my-2 flex justify-end",children:e.jsx("input",{type:"button",className:"flex justify-center btn-secondary h-10 cursor-pointer w-36",value:"+ Add Failure Mode",onClick:()=>x([...r||[],e.jsx(A,{ruleIndex:s,failureMode:{},index:r?.length||0,register:t,control:l,errors:n})])})})]})]})},K={string_contains_any:{display:"String Contains Any"},string_contains_all:{display:"String Contains All"},ip_address:{display:"IP Address"},regex:{display:"Regex"},ts_rfc3339:{display:"Timestamp (RFC3339)"},ts_unix_nano:{display:"Timestamp (Unix Nano)"},ts_unix:{display:"Timestamp (Unix)"},true:{display:"Is True"},false:{display:"Is False"},is_empty:{display:"Is Empty"},pii:{display:"PII (all known types)"},pii_creditcard:{display:"PII Credit Card"},pii_ssn:{display:"PII Social Security Number"},pii_email:{display:"PII Email"},pii_phone:{display:"PII Phone"}},be=({control:s,rule:a,register:t,errors:l,index:n,remove:r})=>{const p=Z({control:s,name:`rules[${n}][match_config.type]`})||a?.match_config?.type;return e.jsxs("div",{className:"flex flex-col justify-start align-top",children:[e.jsxs("div",{className:"flex flex-row justify-between text-stormCloud font-medium text-[14px] leading-[18px] bg-sunset p-2",children:["Rule ",n+1,".",e.jsx(O,{className:"text-stormCloud w-[20px] cursor-pointer",onClick:r})]}),e.jsxs("div",{className:"p-2 w-full",children:[a?.id&&e.jsx(B,{name:`rules[${n}][id]`,value:a.id,register:t}),e.jsx(B,{name:`rules[${n}][type]`,value:"RULE_TYPE_MATCH",register:t}),e.jsx(_,{name:`rules[${n}][match_config.path]`,label:"Field Path",register:t,error:l["match_config.path"]?.message||"",placeholder:"ex: payload.address"}),e.jsx(U,{name:`rules[${n}][match_config.type]`,label:"Field Match Type",register:t,error:l["match_config.type"]?.message||"",children:Object.keys(K).map((i,g)=>e.jsx("option",{value:i,children:K[i].display},`rule-type-match-key-${g}`))}),["string_contains_any","string_contains_all","regex"].includes(p)&&e.jsx(he,{ruleIndex:n,register:t,errors:l}),e.jsx(je,{rule:a,register:t,control:s,errors:l,ruleIndex:n})]})]})};let M;const Ee=new Uint8Array(16);function Re(){if(!M&&(M=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!M))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return M(Ee)}const c=[];for(let s=0;s<256;++s)c.push((s+256).toString(16).slice(1));function Ne(s,a=0){return(c[s[a+0]]+c[s[a+1]]+c[s[a+2]]+c[s[a+3]]+"-"+c[s[a+4]]+c[s[a+5]]+"-"+c[s[a+6]]+c[s[a+7]]+"-"+c[s[a+8]]+c[s[a+9]]+"-"+c[s[a+10]]+c[s[a+11]]+c[s[a+12]]+c[s[a+13]]+c[s[a+14]]+c[s[a+15]]).toLowerCase()}const Se=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Q={randomUUID:Se};function Ue(s,a,t){if(Q.randomUUID&&!a&&!s)return Q.randomUUID();s=s||{};const l=s.random||(s.rng||Re)();if(l[6]=l[6]&15|64,l[8]=l[8]&63|128,a){t=t||0;for(let n=0;n<16;++n)a[t+n]=l[n];return a}return Ne(l)}const ve="Ruleset not found!",z=["RULE_MODE_CONSUME","RULE_MODE_PUBLISH"],C=oe(z),Le=["rabbitmq","kafka"],J=de({name:S().min(1,{message:"Required"}),mode:C,rules:ce()}),Me=me("data_source",[J.extend({data_source:q("kafka"),key:S().min(1,{message:"Required"}),mode:C}),J.extend({data_source:q("rabbitmq"),mode:C,queue_name:S().optional(),exchange_name:S().optional(),binding_key:S().optional()})]).superRefine(({data_source:s,mode:a,...t},l)=>{s==="rabbitmq"&&a==="RULE_MODE_CONSUME"&&!t.queue_name&&l.addIssue({code:T.custom,message:"Queue Name is required",path:["queue_name"],fatal:!0}),s==="rabbitmq"&&a==="RULE_MODE_PUBLISH"&&(!t.exchange_name&&l.addIssue({code:T.custom,message:"Exchange Name is required",path:["exchange_name"],fatal:!0}),!t.binding_key&&l.addIssue({code:T.custom,message:"Binding Key is required",path:["binding_key"],fatal:!0}))}),$e=()=>{const[s,a]=m.useState(!0),[t,l]=m.useState(""),[n,r]=m.useState(!1),[x,p]=m.useState(""),[i,g]=m.useState(null),f=new URLSearchParams(document.location.search).get("id"),{register:u,handleSubmit:W,watch:$,reset:G,control:ee,formState:{errors:h,isSubmitting:I,defaultValues:R}}=ue({reValidateMode:"onBlur",shouldUnregister:!0,resolver:pe(Me),defaultValues:{name:"",data_source:"kafka",mode:"RULE_MODE_CONSUME",rules:[]}}),se=o=>()=>g(i?.filter((d,y)=>o!==y)),F=(o,d)=>e.jsx("div",{className:"border-b",children:e.jsx(be,{index:d,control:ee,rule:o,register:u,errors:h,remove:se(d)})},`rule-key-${d}`),v=$("data_source"),k=$("mode"),ae=async o=>{const{rules:d,exchange_name:y,binding_key:N,queue_name:L,...w}=o,le=d?.reduce((E,j)=>(E[j.id?j.id:Ue()]={...j,failure_mode_configs:j.failure_mode_configs.map(D=>({...D,...D.mode==="RULE_FAILURE_MODE_REJECT"?{reject:{}}:{}}))},E),{}),ne={...w,rules:le,...L&&{key:L},...y&&N&&{key:`${y}|${N}`}};try{const E=await fe({method:R?.id?"PUT":"POST",apiPath:`/v1/ruleset/${R?.id||""}`,body:ne});r(!0);const j=E?.values?.id;j&&(window.location.href=`/ruleset?id=${j}`)}catch(E){p(E.toString())}},te=async()=>{if(!f){a(!1);return}try{const{rules:o,key:d,...y}=await X(`/v1/ruleset/${f}`),N=Object.values(o);g(N?.map((L,w)=>F(L,w))),G({...y,rules:N,...d&&y.data_source==="rabbitmq"&&y.mode==="RULE_MODE_PUBLISH"?{exchange_name:d.substring(0,d.indexOf("|")),binding_key:d.substring(d.indexOf("|")+1)}:d&&y.data_source==="rabbitmq"&&y.mode==="RULE_MODE_CONSUME"?{queue_name:d}:{key:d}})}catch(o){console.error("Error loading ruleset",o),l(ve)}a(!1)};return m.useEffect(()=>{te()},[]),m.useEffect(()=>{if(n){const o=setTimeout(()=>{r(!1),clearTimeout(o)},4e3)}},[n]),s?e.jsx(re,{}):t?e.jsx(P,{error:t}):e.jsxs("div",{className:"max-w-[1440px]",children:[e.jsx("div",{className:"flex flex-row justify-between align-middle pb-4 border-b",children:e.jsxs("div",{className:"flex flex-row justify-start font-bold text-lg leading-5",children:[e.jsx(ie,{className:"mr-2 w-[14px]"}),e.jsxs("span",{className:"text-web",children:[f?"Edit":"Add"," Rule set"," ",R?.name?` - ${R?.name}`:""]})]})}),e.jsxs("form",{onSubmit:W(ae),children:[x?e.jsx(P,{error:x}):null,e.jsxs("div",{className:"pt-4 flex flex-col justify-start max-w-lg",children:[e.jsx(_,{name:"name",label:"Rule Set Name",register:u,error:h.name?.message||""}),e.jsx(U,{name:"data_source",label:"Data Source",register:u,error:h.data_source?.message||"",children:Le.map((o,d)=>e.jsx("option",{value:o,children:_e(o)},`bus-key-${d}`))}),e.jsx(U,{name:"mode",label:"Mode",register:u,error:h.mode?.message||"",children:z.map((o,d)=>e.jsx("option",{value:o,children:o.includes("PUBLISH")?"Publish":"Consume"},`mode-key-${d}`))}),v!=="rabbitmq"&&e.jsx(_,{name:"key",label:"Message Topic",register:u,error:h.key?.message||""}),v==="rabbitmq"&&k==="RULE_MODE_CONSUME"&&e.jsx(_,{name:"queue_name",label:"Queue Name",register:u,error:h.queue_name?.message||""}),v==="rabbitmq"&&k==="RULE_MODE_PUBLISH"&&e.jsx(_,{name:"exchange_name",label:"Exchange Name",register:u,error:h.exchange_name?.message||""}),v==="rabbitmq"&&k==="RULE_MODE_PUBLISH"&&e.jsx(_,{name:"binding_key",label:"Binding Key",register:u,error:h.binding_key?.message||""}),e.jsx("span",{className:"text-stormCloud font-medium text-[14px] leading-[18px] mb-1",children:"Rules"}),e.jsxs("div",{className:"flex flex-col mb-4 rounded-sm border pb-2 text-[14px] font-medium leading-[18px] ",children:[i?.length?i.map(o=>o):e.jsx("div",{className:"p-2 border-b",children:"No rules found"}),e.jsx("div",{className:"w-full mt-2 flex justify-end",children:e.jsx("input",{type:"button",className:"flex justify-center btn-secondary h-10 cursor-pointer",value:"+ Add Rule",onClick:()=>g([...i||[],F({failure_mode_configs:{},match_config:{type:"string_contains_any"}},i?.length||0)])})})]}),e.jsxs("div",{className:"flex flex-row justify-start align-middle",children:[e.jsx("input",{type:"submit",disabled:I,className:`flex justify-center btn-heimdal mr-4 ${I?"cursor-not-allowed":"cursor-pointer"}`,value:R?.id?"Save Ruleset":"Add Ruleset"}),e.jsx("a",{href:"/",children:e.jsx("input",{type:"button",className:"flex justify-center btn-secondary cursor-pointer",value:"Cancel"})}),n?e.jsx(xe,{}):null]})]})]})]})};export{ve as R,$e as a};
